<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">

<body>
<div th:replace="~{fragments/layout :: layout(~{::content})}">
    <div th:fragment="content">

<!-- Breadcrumbs -->
<nav class="flex mb-4 text-sm" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="/" class="text-gray-700 hover:text-indigo-600">
                <i class="fas fa-home mr-1"></i> <span th:text="#{product.detail.home}">Accueil</span>
            </a>
        </li>

        <!-- Affiche toutes les catégories parentes dans l'ordre hiérarchique -->
        <li th:if="${categoryPath != null}" th:each="ancestorCategory, iterStat : ${categoryPath}" th:class="${iterStat.last ? 'last' : ''}">
            <div class="flex items-center">
                <span class="mx-2 text-gray-400">/</span>
                <!-- Afficher un lien pour chaque catégorie parente -->
                <a th:href="${@urlHelper.categoryUrl(ancestorCategory)}"
                   class="text-gray-700 hover:text-indigo-600"
                   th:text="${ancestorCategory.name}">Catégorie parent</a>
            </div>
        </li>

        <li aria-current="page">
            <div class="flex items-center">
                <span class="mx-2 text-gray-400">/</span>
                <span class="text-gray-500" th:text="${product.title}">Produit</span>
            </div>
        </li>
    </ol>
</nav>

<!-- Section principale du produit -->
<div class="bg-white p-6 rounded-xl shadow-lg mb-8">
    <!-- Badges de qualité -->
    <div class="flex flex-wrap gap-2 mb-4">
        <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
            <i class="fas fa-check-circle mr-1"></i> <span th:text="#{product.detail.verified}">Produit vérifié</span>
        </span>
        <span th:if="${product.discountedPrice != null}" class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-medium">
            <i class="fas fa-fire mr-1"></i> <span th:text="#{product.detail.special.offer}">Offre spéciale</span>
        </span>
        <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
            <i class="fas fa-shipping-fast mr-1"></i> <span th:text="#{product.detail.fast.delivery}">Livraison rapide</span>
        </span>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Section images -->
        <div>
            <div class="relative">
                <!-- Image principale - Locale ou URL externe avec haute qualité pour les pages de détail -->
                <div id="mainImage"
                    th:style="${product.image1Path != null} ?
                    |background-image: url(@{'/images/' + ${product.id} + '/1/detail'}), url(/img/placeholder.png); background-size: contain; background-repeat: no-repeat; background-position: center;| :
                    (${product.image1Url != null} ?
                    |background-image: url(${product.image1Url}), url(/img/placeholder.png); background-size: contain; background-repeat: no-repeat; background-position: center;| :
                    'background-image: url(/img/placeholder.png); background-size: contain; background-repeat: no-repeat; background-position: center;')"
                    class="cursor-zoom-in w-full h-96 rounded-lg border shadow-md bg-white"
                    role="button" tabindex="0" th:aria-label="'Agrandir l\'image de ' + ${product.title}">
                </div>
                <!-- Badge de réduction -->
                <div th:if="${product.discountedPrice != null and product.price > product.discountedPrice}" class="absolute top-4 left-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-bold">
                    <span th:text="'-' + ${#numbers.formatInteger(100 - ((product.discountedPrice / product.price) * 100), 0)} + '%'">-20%</span>
                </div>
                <!-- Boutons de partage -->
                <div class="absolute top-4 right-4 flex flex-col gap-2">
                    <button class="transition-all duration-300 hover:scale-105 bg-white bg-opacity-90 p-2 rounded-full shadow-md hover:bg-opacity-100" onclick="shareProduct()" th:title="#{product.detail.share}" th:aria-label="#{product.detail.share.aria}">
                        <i class="fas fa-share-alt text-gray-600"></i>
                    </button>
                    <button class="transition-all duration-300 hover:scale-105 bg-white bg-opacity-90 p-2 rounded-full shadow-md hover:bg-opacity-100" onclick="addToWishlist(this)" th:title="#{product.detail.wishlist}" th:aria-label="#{product.detail.wishlist}">
                        <i class="far fa-heart text-gray-600 hover:text-red-500"></i>
                    </button>
                </div>
            </div>

            <!-- Miniatures -->
            <div class="flex space-x-2 mt-4 overflow-x-auto pb-2">
                <!-- Miniature 1 - Locale ou URL externe -->
                <div th:style="${product.image1Path != null} ?
                    |background-image: url(@{'/images/' + ${product.id} + '/1/card'}), url(/img/placeholder.png); background-size: cover; background-position: center;| :
                    (${product.image1Url != null} ?
                    |background-image: url(${product.image1Url}), url(/img/placeholder.png); background-size: cover; background-position: center;| :
                    'background-image: url(/img/placeholder.png); background-size: cover; background-position: center;')"
             th:alt="${product.title} + ' - Image principale'"
             class="thumbnail-image flex-shrink-0 w-20 h-20 rounded-lg border-2 cursor-pointer hover:opacity-75 transition-all duration-300 ring-2 ring-indigo-500"
             th:data-image-url="${product.image1Path != null} ? @{'/images/' + ${product.id} + '/1/detail'} : (${product.image1Url != null} ? ${product.image1Url} : '/img/placeholder.png')"
             role="button" tabindex="0"></div>

                <!-- Miniature 2 - Locale ou URL externe -->
                <div th:if="${product.image2Path != null || product.image2Url != null}"
             th:style="${product.image2Path != null} ?
                    |background-image: url(@{'/images/' + ${product.id} + '/2/card'}), url(/img/placeholder.png); background-size: cover; background-position: center;| :
                    (${product.image2Url != null} ?
                    |background-image: url(${product.image2Url}), url(/img/placeholder.png); background-size: cover; background-position: center;| :
                    'background-image: url(/img/placeholder.png); background-size: cover; background-position: center;')"
             th:alt="${product.title} + ' - Vue alternative 1'"
             class="thumbnail-image flex-shrink-0 w-20 h-20 rounded-lg border-2 cursor-pointer hover:opacity-75 transition-all duration-300"
             th:data-image-url="${product.image2Path != null} ? @{'/images/' + ${product.id} + '/2/detail'} : (${product.image2Url != null} ? ${product.image2Url} : '/img/placeholder.png')"
             role="button" tabindex="0"></div>

                <!-- Miniature 3 - Locale ou URL externe -->
                <div th:if="${product.image3Path != null || product.image3Url != null}"
             th:style="${product.image3Path != null} ?
                    |background-image: url(@{'/images/' + ${product.id} + '/3/card'}), url(/img/placeholder.png); background-size: cover; background-repeat: no-repeat; background-position: center;| :
                    (${product.image3Url != null} ?
                    |background-image: url(${product.image3Url}), url(/img/placeholder.png); background-size: cover; background-repeat: no-repeat; background-position: center;| :
                    'background-image: url(/img/placeholder.png); background-size: cover; background-repeat: no-repeat; background-position: center;')"
             th:alt="${product.title} + ' - Vue alternative 2'"
             class="thumbnail-image flex-shrink-0 w-20 h-20 rounded-lg border-2 cursor-pointer hover:opacity-75 transition-all duration-300"
             th:data-image-url="${product.image3Path != null} ? @{'/images/' + ${product.id} + '/3/detail'} : (${product.image3Url != null} ? ${product.image3Url} : '/img/placeholder.png')"
             role="button" tabindex="0"></div>
            </div>
        </div>

        <!-- Section informations -->
        <div>
            <h1 class="text-4xl font-bold mb-3 text-gray-900" th:text="${product.title}">Titre</h1>

            <!-- Marque du produit -->
            <div th:if="${product.brand != null and !#strings.isEmpty(product.brand)}" class="flex items-center mb-4 p-2 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">
                    <i class="fas fa-tag"></i>
                </div>
                <div>
                    <p class="text-sm text-blue-600 font-medium" th:text="#{product.detail.brand}">Marque</p>
                    <p class="font-semibold text-blue-800" th:text="${product.brand}">Marque du produit</p>
                </div>
            </div>

            <!-- Type de produit (Neuf/D'occasion) -->
            <div th:if="${product.productType != null}" class="flex items-center mb-4 p-2 rounded-lg border-l-4"
                 th:classappend="${product.productType.name() == 'NEW'} ? 'bg-green-50 border-green-400' : 'bg-orange-50 border-orange-400'">
                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3"
                     th:classappend="${product.productType.name() == 'NEW'} ? 'bg-green-500' : 'bg-orange-500'">
                    <i th:class="${product.productType.name() == 'NEW'} ? 'fas fa-star' : 'fas fa-recycle'"></i>
                </div>
                <div>
                    <p class="text-sm font-medium" th:classappend="${product.productType.name() == 'NEW'} ? 'text-green-600' : 'text-orange-600'" th:text="#{product.detail.condition}">État</p>
                    <p class="font-semibold"
                       th:classappend="${product.productType.name() == 'NEW'} ? 'text-green-800' : 'text-orange-800'"
                       th:text="${product.productType.displayName}">Neuf</p>
                </div>
            </div>

            <!-- Vendeur -->
            <div th:if="${product.seller != null and product.seller.sellerPro}" class="flex items-center mb-4 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                <div class="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-white font-bold mr-3">
                    <i class="fas fa-store"></i>
                </div>
                <div class="flex-1">
                    <p class="text-sm text-gray-600" th:text="#{product.detail.sold.by}">Vendu par</p>
                    <a th:href="@{'/vendeur/' + ${product.seller.id}}"
                       class="font-medium text-indigo-600 hover:text-indigo-800 hover:underline transition-colors duration-200"
                       th:text="${product.seller.marquee}">Vendeur</a>
                </div>
                <div class="text-gray-400">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <!-- Description courte sous le bloc vendeur -->
            <p class="mb-4 text-gray-600 text-lg leading-relaxed" th:text="${product.shortDescription}" th:if="${product.shortDescription != null and !#strings.isEmpty(product.shortDescription)}">Description courte du produit</p>

            <!-- Indicateur de stock -->
            <div class="flex items-center gap-2 mb-4">
                <div th:if="${product.stock == null or product.stock.name() == 'INSTOCK'}" class="w-2 h-2 rounded-full bg-green-500"></div>
                <div th:if="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'}" class="w-2 h-2 rounded-full bg-red-500"></div>
                <span th:if="${product.stock == null or product.stock.name() == 'INSTOCK'}" class="text-green-700 font-medium" th:text="#{product.detail.in.stock}">En stock</span>
                <span th:if="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'}" class="text-red-700 font-medium" th:text="#{product.detail.out.of.stock}">Rupture de stock</span>
                <span th:if="${product.stock == null or product.stock.name() == 'INSTOCK'}" class="text-gray-500 text-sm ml-2" th:text="'(' + #{product.detail.available} + ')'">Articles disponibles</span>
                <span th:if="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'}" class="text-gray-500 text-sm ml-2" th:text="'(' + #{product.detail.unavailable} + ')'">Indisponible actuellement</span>
            </div>

            <!-- Prix -->
            <div class="mb-6 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                <div th:if="${product.discountedPrice != null}" class="flex items-baseline gap-3">
                    <span class="text-3xl font-bold text-indigo-600" th:text="${#numbers.formatDecimal(product.discountedPrice, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode}">0</span>
                    <span class="text-gray-500 line-through text-xl" th:text="${#numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode}">0</span>
                    <span class="text-sm bg-red-500 text-white px-2 py-1 rounded-full font-medium">
                        <span th:text="#{product.detail.save}">Économisez</span> <span th:text="${#numbers.formatDecimal(product.price - product.discountedPrice, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode}">0</span>
                    </span>
                </div>
                <div th:if="${product.discountedPrice == null}">
                    <span class="text-3xl font-bold text-indigo-600" th:text="${#numbers.formatDecimal(product.price, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode}">0</span>
                </div>
            </div>

            <!-- Formulaire d'ajout au panier amélioré -->
            <div class="bg-white border-2 border-gray-100 rounded-xl p-6">
                <form id="addToCartForm" th:action="@{'/cart/add/' + ${product.id}}" method="post" class="add-to-cart-form space-y-4">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label for="quantity" class="text-sm font-medium text-gray-700 mr-3" th:text="#{product.detail.quantity}">Quantité:</label>
                            <div class="flex items-center border border-gray-300 rounded-lg">
                                <button type="button" onclick="decreaseQuantity()" class="px-3 py-2 text-gray-500 hover:text-gray-700">-</button>
                                <input type="number" id="quantity" name="qty" value="1" min="1" max="10" class="w-16 text-center border-0 focus:ring-0 focus:outline-none">
                                <button type="button" onclick="increaseQuantity()" class="px-3 py-2 text-gray-500 hover:text-gray-700">+</button>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                    <div>
                        <button type="submit" id="addToCartBtn"
                                th:disabled="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'}"
                                th:class="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'} ?
                                    'w-full bg-gray-400 text-white py-3 px-6 rounded-lg font-medium cursor-not-allowed opacity-50' :
                                    'w-full bg-gradient-to-br from-indigo-500 to-purple-600 text-white py-3 px-6 rounded-lg font-medium hover:opacity-90 transition-all duration-300 shadow-lg hover:shadow-xl'">
                            <i class="fas fa-shopping-cart mr-2"></i>
                            <span id="addToCartText" th:text="${product.stock != null and product.stock.name() == 'OUTOFSTOCK'} ? #{product.detail.unavailable.product} : #{product.detail.add.to.cart}">Ajouter au panier</span>
                        </button>
                    </div>
                </form>

                <!-- Caractéristiques rapides -->
                <div class="mt-6 grid grid-cols-2 gap-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full text-white text-sm">
                            <i class="fas fa-truck"></i>
                        </div>
                        <span class="text-sm text-gray-600" th:text="#{product.detail.standard.delivery}">Livraison standard 3-5 jours ouvrables</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full text-white text-sm">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span class="text-sm text-gray-600" th:text="#{product.detail.secure.payment}">Paiement sécurisé</span>
                    </div>
                </div>

                <!-- Informations de livraison -->
                <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-center text-green-700">
                        <i class="fas fa-truck mr-2"></i>
                        <span class="text-sm font-medium" th:text="#{product.detail.standard.delivery}">Livraison standard 3-5 jours ouvrables</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section onglets avec détails -->
<div class="bg-white rounded-xl shadow-lg mb-8">
    <div class="border-b border-gray-200">
        <nav class="-mb-px flex" aria-label="Onglets du produit">
            <button class="tab-button active py-4 px-6 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" onclick="showTab('description')" th:aria-label="'Afficher la ' + #{product.detail.description.tab}">
                <span th:text="#{product.detail.description.tab}">Description détaillée</span>
            </button>
            <!-- Onglet Spécifications temporairement caché
            <button class="tab-button py-4 px-6 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" onclick="showTab('specifications')" aria-label="Afficher les spécifications">
                Spécifications
            </button>
            -->
            <button class="tab-button py-4 px-6 text-sm font-medium text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300" onclick="showTab('shipping')" th:aria-label="'Afficher les informations de ' + #{product.detail.shipping.tab}">
                <span th:text="#{product.detail.shipping.tab}">Livraison & Retour</span>
            </button>
        </nav>
    </div>

    <div class="p-6">
        <!-- Onglet Description -->
        <div id="description" class="block">
            <h2 class="text-xl font-semibold mb-4" th:text="#{product.detail.detailed.description}">Description détaillée</h2>
            <div class="prose max-w-none">
                <!-- Description dynamique du produit -->
                <div th:if="${product.description != null and !#strings.isEmpty(product.description)}">
                    <p class="text-gray-700 leading-relaxed mb-6 whitespace-pre-line" th:text="${product.description}">Description complète du produit...</p>
                </div>
                <div th:if="${product.description == null or #strings.isEmpty(product.description)}">
                    <p class="text-gray-500 italic mb-6" th:text="#{product.detail.no.description}">Aucune description détaillée disponible pour ce produit.</p>
                </div>

                <!-- Informations sur le vendeur -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold mb-2" th:text="#{product.detail.about.seller}">À propos du vendeur</h3>
                    <p class="text-gray-700" th:text="#{product.detail.sold.by.text(${product.seller != null ? (product.seller.marquee != null and !#strings.isEmpty(product.seller.marquee) ? product.seller.marquee : product.seller.marquee) : 'marketcore'})}">Ce produit est vendu par marketcore.</p>
                </div>
            </div>
        </div>

        <!-- Onglet Spécifications -->
        <div id="specifications" class="hidden">
            <h3 class="text-xl font-semibold mb-4">Spécifications techniques</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Marque:</span>
                        <span class="text-gray-900">marketcore</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Modèle:</span>
                        <span class="text-gray-900" th:text="${product.id}">TB-001</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Catégorie:</span>
                        <span class="text-gray-900" th:text="${product.category.name}">Électronique</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Garantie:</span>
                        <span class="text-gray-900">2 ans</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Poids:</span>
                        <span class="text-gray-900">1.2 kg</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-100">
                        <span class="font-medium text-gray-600">Origine:</span>
                        <span class="text-gray-900" th:text="${siteCountry}">France</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Onglet Livraison -->
        <div id="shipping" class="hidden">
            <h3 class="text-xl font-semibold mb-4">Livraison & Retour</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-semibold mb-3 text-gray-900">Options de livraison</h4>
                    <div class="space-y-3">
                        <div class="flex items-center p-3 border border-gray-200 rounded-lg">
                            <i class="fas fa-truck text-green-500 mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-900">Livraison standard</p>
                                <p class="text-sm text-gray-600">3-5 jours ouvrables</p>
                            </div>
                        </div>
                        <div class="flex items-center p-3 border border-gray-200 rounded-lg">
                            <i class="fas fa-bolt text-orange-500 mr-3"></i>
                            <div>
                                <p class="font-medium text-gray-900">Livraison express</p>
                                <p class="text-sm text-gray-600">24-48h - 8 EUR</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold mb-3 text-gray-900">Politique de retour</h4>
                    <div class="space-y-3">
                        <div class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-3 mt-1"></i>
                            <p class="text-sm text-gray-700">Retour gratuit sous 30 jours</p>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-3 mt-1"></i>
                            <p class="text-sm text-gray-700">Produit dans son emballage d'origine</p>
                        </div>
                        <div class="flex items-start">
                            <i class="fas fa-check text-green-500 mr-3 mt-1"></i>
                            <p class="text-sm text-gray-700">Remboursement sous 7 jours</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section produits recommandés -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h3 class="text-2xl font-bold mb-6 text-gray-900">Produits recommandés</h3>

    <!-- Carousel des produits recommandés -->
    <div class="relative">
        <div class="carousel-container overflow-hidden touch-pan-x" id="carouselContainer">
            <div id="recommendedProductsCarousel" class="carousel-inner flex transition-transform duration-300 ease-out">
                <!-- Conteneur des produits recommandés - rendu dynamique -->
                <div th:each="p, iterStat : ${recommendedProducts}" th:if="${recommendedProducts != null and not #lists.isEmpty(recommendedProducts)}"
                     class="carousel-item flex-none w-1/2 sm:w-1/2 md:w-1/3 lg:w-1/4 p-2">
                    <!-- Box produit dans le même style que la page liste -->
                    <a th:href="${@urlHelper.productUrl(p.id, p.title)}" class="product-card product-box bg-white rounded-xl shadow hover:shadow-lg transition p-3 sm:p-4 flex flex-col cursor-pointer relative">
                        <div class="relative">
                            <!-- Pastille PROMO pour les produits avec discount -->
                            <div th:if="${p.discountedPrice != null and p.discountedPrice < p.price}"
                                 class="absolute top-1 left-1 sm:top-2 sm:left-2 z-10 bg-gradient-to-r from-red-500 to-pink-500 text-white text-xs font-bold px-2 py-0.5 sm:px-3 sm:py-1 rounded-full shadow-lg transform -rotate-12">
                                <span class="flex items-center">
                                    <svg class="w-2 h-2 sm:w-3 sm:h-3 mr-0.5 sm:mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    <span class="text-2xs sm:text-xs">PROMO</span>
                                </span>
                            </div>

                            <!-- Image du produit -->
                            <div class="relative">
                                <!-- Image URL externe -->
                                <img th:if="${p.image1Url != null}"
                                     th:src="${p.image1Url}"
                                     th:alt="${p.title}"
                                     class="h-32 sm:h-44 w-full object-contain mb-2 sm:mb-3 rounded bg-gray-50">
                                <!-- Image locale ou image par défaut -->
                                <img th:if="${p.image1Url == null}"
                                     th:src="${p.image1Path != null ? '/images/' + p.id + '/1' : '/img/placeholder.png'}"
                                     th:alt="${p.title}"
                                     class="h-32 sm:h-44 w-full object-contain mb-2 sm:mb-3 rounded bg-gray-50">
                            </div>
                        </div>
                        <h2 class="text-sm sm:text-base font-semibold mb-0.5 sm:mb-1 line-clamp-1" th:text="${p.title}">Titre</h2>
                        <p class="text-xs sm:text-sm text-gray-600 mb-1 sm:mb-2 line-clamp-2" th:text="${p.shortDescription != null && !#strings.isEmpty(p.shortDescription) ? p.shortDescription : ''}">Description</p>

                        <div class="flex items-center mb-1 sm:mb-2">
                            <div th:if="${p.discountedPrice != null}" class="flex items-center gap-1 sm:gap-2">
                                <span class="text-xs sm:text-base text-indigo-600 font-bold" th:text="${#numbers.formatDecimal(p.discountedPrice, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode != null ? currencyCode : '€'}">0 €</span>
                                <span class="text-2xs sm:text-sm text-gray-500 line-through" th:text="${#numbers.formatDecimal(p.price, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode != null ? currencyCode : '€'}">0 €</span>
                                <span th:if="${p.price > p.discountedPrice}" class="text-2xs sm:text-xs bg-red-100 text-red-800 px-1 py-0.5 sm:px-2 sm:py-1 rounded-full font-semibold"
                                    th:text="'-' + ${#numbers.formatInteger(100 - ((p.discountedPrice / p.price) * 100), 0)} + '%'">-20%</span>
                            </div>
                            <p th:if="${p.discountedPrice == null}" class="text-xs sm:text-base text-indigo-600 font-bold" th:text="${#numbers.formatDecimal(p.price, 1, 'COMMA', 2, 'POINT')} + ' ' + ${currencyCode != null ? currencyCode : '€'}">0 €</p>
                        </div>

                        <!-- Bouton voir le produit -->
                        <div class="mt-auto">
                            <button class="w-full bg-indigo-600 text-white px-3 py-1 text-sm rounded hover:bg-indigo-700 transition">
                                Voir le produit
                            </button>
                        </div>
                    </a>
                </div>

                <!-- Message si pas de recommandations -->
                <div th:if="${recommendedProducts == null or #lists.isEmpty(recommendedProducts)}" class="w-full flex justify-center items-center py-8">
                    <div class="text-center">
                        <p class="text-gray-500">Aucun produit recommandé disponible pour le moment.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Indicateurs de pagination -->
        <div id="carouselIndicators" class="flex justify-center mt-4 space-x-2">
            <!-- Les indicateurs seront générés dynamiquement -->
        </div>
    </div>
</div>

<!-- Modal pour agrandir l'image -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50 hidden">
    <div class="relative max-w-4xl max-h-full p-4">
        <img id="modalImage" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg">
        <button id="closeModal" class="absolute top-2 right-2 text-white text-3xl font-bold hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center">
            &times;
        </button>
    </div>
</div>

<!-- Structured Data Generator et JavaScript -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function() {
        // Get product data from Thymeleaf variables
        const productTitle = /*[[${product.title}]]*/ 'Produit';
        const productDescription = /*[[${product.description}]]*/ 'Description du produit';
        const productId = /*[[${product.id}]]*/ '123';
        const productPrice = /*[[${product.price}]]*/ '99.99';
        const currencyCode = /*[[${currencyCode}]]*/ 'EUR';
        const sellerName = /*[[${product.seller != null ? product.seller.fullName : 'marketcore'}]]*/ 'Vendeur';
        
        // Get URL components
        const baseUrl = window.location.protocol + '//' + window.location.host;
        const currentUrl = window.location.href;
        const imageUrl = baseUrl + '/images/' + productId + '/1';
        
        // Get category info
        const categoryName = /*[[${product.category.name}]]*/ 'Catégorie';
        const categoryUrl = baseUrl + /*[[${'/category/' + product.category.id}]]*/ '/category/1';

        // Create future date for priceValidUntil (1 month from now)
        const futureDate = new Date();
        futureDate.setMonth(futureDate.getMonth() + 1);
        const priceValidUntil = futureDate.toISOString().split('T')[0]; // Format as YYYY-MM-DD
        
        // Create Product schema
        const productSchema = {
            "@context": "https://schema.org",
            "@type": "Product",
            "name": productTitle,
            "description": productDescription || "Description du produit " + productTitle, // Garantir qu'il y a toujours une description
            "image": imageUrl,
            "sku": productId,
            "mpn": productId,
            "brand": {
                "@type": "Brand",
                "name": /*[[${product.brand != null && !#strings.isEmpty(product.brand) ? product.brand : 'marketcore'}]]*/ "marketcore"
            },
            "offers": {
                "@type": "Offer",
                "url": currentUrl,
                "priceCurrency": currencyCode,
                "price": /*[[${product.discountedPrice != null ? product.discountedPrice : product.price}]]*/ productPrice,
                "priceValidUntil": "2026-12-31", // Date fixe dans le futur pour éviter les problèmes de validité
                "availability": /*[[${product.stock != null and product.stock.name() == 'OUTOFSTOCK' ? 'https://schema.org/OutOfStock' : 'https://schema.org/InStock'}]]*/ "https://schema.org/InStock",
                "seller": {
                    "@type": "Organization",
                    "name": sellerName
                },
                // Ajout des détails d'expédition requis
                "shippingDetails": {
                    "@type": "OfferShippingDetails",
                    "shippingRate": {
                        "@type": "MonetaryAmount",
                        "value": "0",
                        "currency": currencyCode
                    },
                    "shippingDestination": {
                        "@type": "DefinedRegion",
                        "addressCountry": "TN"
                    },
                    "deliveryTime": {
                        "@type": "ShippingDeliveryTime",
                        "handlingTime": {
                            "@type": "QuantitativeValue",
                            "minValue": "0",
                            "maxValue": "1",
                            "unitCode": "DAY"
                        },
                        "transitTime": {
                            "@type": "QuantitativeValue",
                            "minValue": "1",
                            "maxValue": "5",
                            "unitCode": "DAY"
                        }
                    }
                }
            }
        };
        
        // Create BreadcrumbList schema
        const breadcrumbSchema = {
            "@context": "https://schema.org",
            "@type": "BreadcrumbList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "Accueil",
                    "item": baseUrl
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": categoryName,
                    "item": categoryUrl
                },
                {
                    "@type": "ListItem",
                    "position": 3,
                    "name": productTitle
                }
            ]
        };
        
        // Add schemas to the page
        const productScriptTag = document.createElement('script');
        productScriptTag.type = 'application/ld+json';
        productScriptTag.textContent = JSON.stringify(productSchema);
        document.head.appendChild(productScriptTag);
        
        const breadcrumbScriptTag = document.createElement('script');
        breadcrumbScriptTag.type = 'application/ld+json';
        breadcrumbScriptTag.textContent = JSON.stringify(breadcrumbSchema);
        document.head.appendChild(breadcrumbScriptTag);

        // Image gallery functionality
        const mainImage = document.getElementById('mainImage');
        const thumbnailImages = document.querySelectorAll('.thumbnail-image');

        // Add click event listeners to thumbnail images
        thumbnailImages.forEach(thumbnail => {
            thumbnail.addEventListener('click', function() {
                const newImageUrl = this.getAttribute('data-image-url');
                const newStyle = "background-image: url('" + newImageUrl + "'), url(/img/placeholder.png); background-size: contain; background-repeat: no-repeat; background-position: center;";

                mainImage.style.opacity = '0.5';

                setTimeout(() => {
                    mainImage.style.cssText = newStyle;
                    mainImage.style.opacity = '1';
                }, 150);

                thumbnailImages.forEach(thumb => {
                    thumb.classList.remove('ring-2', 'ring-indigo-500');
                });
                this.classList.add('ring-2', 'ring-indigo-500');
            });
        });

        // Modal functionality
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');

        mainImage.addEventListener('click', function() {
            imageModal.classList.remove('hidden');
            // Extract the image URL from the background-image style
            const bgImage = window.getComputedStyle(this).backgroundImage;
            const urlMatch = bgImage.match(/url\(["']?([^"']+)["']?\)/);
            if (urlMatch && urlMatch[1]) {
                modalImage.src = urlMatch[1];
            }
        });

        closeModal.addEventListener('click', function() {
            imageModal.classList.add('hidden');
        });

        imageModal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.add('hidden');
            }
        });

        // Enhanced form submission with feedback
        const addToCartForm = document.getElementById('addToCartForm');
        const addToCartBtn = document.getElementById('addToCartBtn');
        const addToCartText = document.getElementById('addToCartText');

        addToCartForm.addEventListener('submit', function(e) {
            // Show loading state
            addToCartBtn.disabled = true;
            addToCartText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ajout en cours...';

            // Re-enable after a short delay (in case of error)
            setTimeout(() => {
                addToCartBtn.disabled = false;
                addToCartText.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i>Ajouter au panier';
            }, 3000);
        });
    });

    // Fonctions utilitaires
    function showTab(tabName) {
        // Cacher tous les onglets
        document.querySelectorAll('[id="description"], [id="specifications"], [id="shipping"]').forEach(tab => {
            tab.classList.add('hidden');
            tab.classList.remove('block');
        });

        // Désactiver tous les boutons d'onglets
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('border-indigo-500', 'text-indigo-600');
            button.classList.add('border-transparent', 'text-gray-500');
        });

        // Afficher l'onglet actuel
        document.getElementById(tabName).classList.remove('hidden');
        document.getElementById(tabName).classList.add('block');

        // Activer le bouton correspondant
        event.target.classList.remove('border-transparent', 'text-gray-500');
        event.target.classList.add('border-indigo-500', 'text-indigo-600');
    }

    function increaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        let currentValue = parseInt(quantityInput.value);
        if (currentValue < parseInt(quantityInput.max)) {
            quantityInput.value = currentValue + 1;
        }
    }

    function decreaseQuantity() {
        const quantityInput = document.getElementById('quantity');
        let currentValue = parseInt(quantityInput.value);
        if (currentValue > parseInt(quantityInput.min)) {
            quantityInput.value = currentValue - 1;
        }
    }

    function shareProduct() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                text: 'Découvrez ce produit sur marketcore',
                url: window.location.href
            });
        } else {
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Lien copié dans le presse-papier !');
            });
        }
    }

    function addToWishlist(button) {
        const heartIcon = button.querySelector('i');
        if (heartIcon.classList.contains('far')) {
            heartIcon.classList.remove('far');
            heartIcon.classList.add('fas');
            heartIcon.style.color = '#ef4444';
            alert('Produit ajouté aux favoris !');
        } else {
            heartIcon.classList.remove('fas');
            heartIcon.classList.add('far');
            heartIcon.style.color = '';
            alert('Produit retiré des favoris !');
        }
    }

    function buyNow() {
        // Récupération des données du produit
        const productId = /*[[${product.id}]]*/ '123';
        const quantity = document.getElementById('quantity').value;
        const buyNowBtn = document.getElementById('buyNowBtn');
        const buyNowText = document.getElementById('buyNowText');
        const csrfToken = document.querySelector('input[name="_csrf"]').value;
        const csrfParameterName = document.querySelector('input[name="_csrf"]').name;

        // Afficher l'état de chargement
        buyNowBtn.disabled = true;
        buyNowText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Ajout et redirection...';

        // Créer les données du formulaire
        const formData = new FormData();
        formData.append('qty', quantity);
        formData.append(csrfParameterName, csrfToken);

        // Envoyer la requête AJAX pour ajouter au panier
        fetch('/cart/add/' + productId, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => {
            if (response.ok) {
                // Redirection immédiate vers la page du panier
                window.location.href = '/cart';
            } else {
                throw new Error('Erreur lors de l\'ajout au panier');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de l\'ajout au panier. Veuillez réessayer.');

            // Restaurer le bouton en cas d'erreur
            buyNowBtn.disabled = false;
            buyNowText.innerHTML = '<i class="fas fa-bolt mr-2"></i>Acheter maintenant';
        });
    }

    // Fonction pour le carousel des produits recommandés avec swipe
    function initRecommendedProductsCarousel() {
        const carousel = document.getElementById('recommendedProductsCarousel');
        const carouselContainer = document.getElementById('carouselContainer');
        const indicatorsContainer = document.getElementById('carouselIndicators');

        if (!carousel) return;

        const items = carousel.querySelectorAll('.carousel-item');

        if (items.length <= 0) return;

        let currentIndex = 0;
        let isTransitioning = false;

        // Variables pour le swipe
        let startX = 0;
        let currentX = 0;
        let isDragging = false;
        let startTime = 0;

        const itemsPerView = getItemsPerView();
        const totalSlides = Math.max(0, items.length - itemsPerView);

        // Créer les indicateurs de pagination
        createCarouselIndicators();

        // Initialiser la position
        updateCarouselPosition();

        // Event listeners pour le swipe tactile
        carouselContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
        carouselContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
        carouselContainer.addEventListener('touchend', handleTouchEnd, { passive: true });

        // Event listeners pour le swipe souris (desktop)
        carouselContainer.addEventListener('mousedown', handleMouseDown);
        carouselContainer.addEventListener('mousemove', handleMouseMove);
        carouselContainer.addEventListener('mouseup', handleMouseUp);
        carouselContainer.addEventListener('mouseleave', handleMouseUp);

        // Adapter le carousel lors du redimensionnement de la fenêtre
        window.addEventListener('resize', () => {
            const newItemsPerView = getItemsPerView();
            const newTotalSlides = Math.max(0, items.length - newItemsPerView);

            if (currentIndex > newTotalSlides) {
                currentIndex = newTotalSlides;
            }

            updateCarouselPosition();
            createCarouselIndicators();
        });

        // Fonctions de gestion du touch/swipe
        function handleTouchStart(e) {
            startSwipe(e.touches[0].clientX);
        }

        function handleTouchMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            updateSwipe(e.touches[0].clientX);
        }

        function handleTouchEnd(e) {
            endSwipe();
        }

        function handleMouseDown(e) {
            e.preventDefault();
            startSwipe(e.clientX);
        }

        function handleMouseMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            updateSwipe(e.clientX);
        }

        function handleMouseUp(e) {
            endSwipe();
        }

        function startSwipe(clientX) {
            if (isTransitioning) return;

            startX = clientX;
            currentX = clientX;
            isDragging = true;
            startTime = Date.now();

            carousel.style.transition = 'none';
            carouselContainer.style.cursor = 'grabbing';
        }

        function updateSwipe(clientX) {
            if (!isDragging) return;

            currentX = clientX;
            const diffX = currentX - startX;
            const itemWidth = carousel.querySelector('.carousel-item').offsetWidth;
            const currentTransform = -currentIndex * itemWidth + diffX;

            carousel.style.transform = `translateX(${currentTransform}px)`;
        }

        function endSwipe() {
            if (!isDragging) return;

            isDragging = false;
            carouselContainer.style.cursor = 'grab';

            const diffX = currentX - startX;
            const swipeTime = Date.now() - startTime;
            const itemWidth = carousel.querySelector('.carousel-item').offsetWidth;

            // Déterminer si c'est un swipe valide
            const isQuickSwipe = swipeTime < 300;
            const isLongSwipe = Math.abs(diffX) > itemWidth * 0.3;

            if ((isQuickSwipe && Math.abs(diffX) > 50) || isLongSwipe) {
                if (diffX > 0 && currentIndex > 0) {
                    // Swipe vers la droite - aller au précédent
                    currentIndex--;
                } else if (diffX < 0 && currentIndex < totalSlides) {
                    // Swipe vers la gauche - aller au suivant
                    currentIndex++;
                }
            }

            // Restaurer la transition et mettre à jour la position
            carousel.style.transition = 'transform 0.3s ease-out';
            updateCarouselPosition();
        }

        // Créer les indicateurs de pagination
        function createCarouselIndicators() {
            indicatorsContainer.innerHTML = '';

            if (totalSlides <= 0) return;

            for (let i = 0; i <= totalSlides; i++) {
                const indicator = document.createElement('div');
                indicator.className = `carousel-indicator ${i === currentIndex ? 'active' : ''}`;
                indicator.addEventListener('click', () => goToSlide(i));
                indicatorsContainer.appendChild(indicator);
            }
        }

        // Aller à une slide spécifique
        function goToSlide(index) {
            if (isTransitioning || index === currentIndex) return;

            currentIndex = index;
            updateCarouselPosition();
        }

        // Mettre à jour la position du carousel
        function updateCarouselPosition() {
            if (isTransitioning) return;

            isTransitioning = true;
            const itemWidth = carousel.querySelector('.carousel-item').offsetWidth;
            carousel.style.transform = `translateX(-${currentIndex * itemWidth}px)`;

            // Mettre à jour les indicateurs
            updateIndicators();

            setTimeout(() => {
                isTransitioning = false;
            }, 300);
        }

        // Mettre à jour les indicateurs actifs
        function updateIndicators() {
            const indicators = indicatorsContainer.querySelectorAll('.carousel-indicator');
            indicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index === currentIndex);
            });
        }

        // Déterminer le nombre d'éléments visibles en fonction de la largeur de l'écran
        function getItemsPerView() {
            const viewportWidth = window.innerWidth;
            if (viewportWidth < 640) {
                return 2; // Mobile - 2 éléments par défaut
            } else if (viewportWidth < 768) {
                return 2; // Tablette small - 2 éléments
            } else if (viewportWidth < 1024) {
                return 3; // Tablette large - 3 éléments
            } else {
                return 4; // Desktop - 4 éléments
            }
        }
    }

    // Initialiser le carousel après le chargement du DOM
    document.addEventListener('DOMContentLoaded', function() {
        // Code existant...

        // Initialiser le carousel des produits recommandés
        initRecommendedProductsCarousel();
    });
</script>

<style>
    /* Styles pour la troncation du texte */
    .line-clamp-1 {
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Ajuster la taille du texte pour les petits écrans */
    @media (max-width: 640px) {
        .text-2xs {
            font-size: 0.625rem;
        }
    }

    /* Styles spécifiques pour le carousel */
    .carousel-container {
        position: relative;
        overflow: hidden;
        touch-action: pan-y;
        cursor: grab;
    }

    .carousel-inner {
        display: flex;
        transition: transform 0.3s ease-out;
    }

    .carousel-item {
        flex: 0 0 auto;
        /* La largeur est maintenant contrôlée par les classes Tailwind w-1/2, w-1/3, etc. */
    }

    /* Indicateurs de pagination */
    #carouselIndicators {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        gap: 0.5rem;
    }

    .carousel-indicator {
        width: 10px;
        height: 10px;
        background-color: #d1d5db;
        border-radius: 50%;
        display: inline-block;
        cursor: pointer;
    }

    .carousel-indicator.active {
        background-color: #4f46e5;
    }
</style>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<body>
<div th:replace="~{admin/admin-layout-v2 :: layout(~{::content})}">
    <div th:fragment="content">

        <!-- En-t√™te -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-vial text-blue-600 mr-3"></i>Test d'Optimisation sur un Produit
                    </h1>
                    <p class="text-gray-600">Testez l'optimisation sur les images d'un produit existant</p>
                </div>
                <div class="flex gap-3">
                    <a href="/admin/optimize-images" class="text-green-600 hover:text-green-800 transition font-semibold">
                        <i class="fas fa-arrow-right mr-2"></i>Optimisation compl√®te
                    </a>
                    <a href="/admin" class="text-gray-600 hover:text-gray-800 transition">
                        <i class="fas fa-arrow-left mr-2"></i>Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- S√©lection du produit -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                    <i class="fas fa-box-open text-blue-600 mr-2"></i>
                    S√©lectionnez un produit √† tester
                </h2>

                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Choisissez un produit :</label>
                    <select id="productSelect"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none">
                        <option value="">-- S√©lectionnez un produit --</option>
                        <option th:each="product : ${products}"
                                th:value="${product.id}"
                                th:text="${product.title + ' (ID: ' + product.id + ')'}">
                        </option>
                    </select>
                </div>

                <div id="selectedProductInfo" class="hidden bg-gray-50 rounded-xl p-6 mb-6">
                    <h3 class="font-semibold text-gray-800 mb-3">Produit s√©lectionn√© :</h3>
                    <div class="flex items-center justify-between">
                        <div>
                            <p id="selectedProductName" class="font-bold text-lg text-gray-900"></p>
                            <p class="text-sm text-gray-600 mt-1">Les images de ce produit seront optimis√©es</p>
                        </div>
                    </div>
                </div>

                <button onclick="testOptimizeProduct()"
                        id="testBtn"
                        disabled
                        class="w-full bg-gradient-to-r from-blue-500 to-teal-600 text-white px-6 py-4 rounded-xl font-bold text-lg hover:from-blue-600 hover:to-teal-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-play mr-2"></i>Tester l'optimisation sur ce produit
                </button>

                <div class="mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-yellow-600 text-xl mr-3 mt-1"></i>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">√Ä propos du test</p>
                            <p>‚Ä¢ Les images du produit s√©lectionn√© seront r√©ellement optimis√©es</p>
                            <p>‚Ä¢ Vous verrez le gain exact pour chaque image</p>
                            <p>‚Ä¢ Si le gain est > 10%, l'image sera remplac√©e</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone de chargement -->
        <div id="loadingSection" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="max-w-2xl mx-auto text-center">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-blue-100 rounded-full mb-4">
                        <i class="fas fa-spinner fa-spin text-blue-600 text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">Optimisation en cours...</h3>
                    <p class="text-gray-600">Analyse et optimisation des images du produit</p>
                </div>
            </div>
        </div>

        <!-- R√©sultats -->
        <div id="resultSection" class="hidden">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="max-w-4xl mx-auto">
                    <!-- En-t√™te du r√©sultat -->
                    <div class="text-center mb-8">
                        <div id="resultIcon" class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
                            <i class="fas fa-check-circle text-green-600 text-4xl"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-green-800 mb-2">Test r√©ussi !</h2>
                        <p id="productNameResult" class="text-gray-600 text-lg"></p>
                    </div>

                    <!-- Statistiques globales -->
                    <div class="grid md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-blue-50 rounded-xl p-6 text-center">
                            <div class="text-4xl font-bold text-blue-600 mb-2" id="totalImages"></div>
                            <div class="text-sm text-blue-800">Images trait√©es</div>
                        </div>
                        <div class="bg-purple-50 rounded-xl p-6 text-center">
                            <div class="text-4xl font-bold text-purple-600 mb-2" id="totalSaved"></div>
                            <div class="text-sm text-purple-800">√âconomie totale</div>
                        </div>
                        <div class="bg-green-50 rounded-xl p-6 text-center">
                            <div class="text-4xl font-bold text-green-600 mb-2" id="reductionPercent"></div>
                            <div class="text-sm text-green-800">R√©duction</div>
                        </div>
                    </div>

                    <!-- D√©tails par image -->
                    <div class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">
                            <i class="fas fa-list mr-2"></i>D√©tails par image
                        </h3>
                        <div id="imageDetails" class="space-y-4">
                            <!-- Sera rempli par JavaScript -->
                        </div>
                    </div>

                    <!-- Interpr√©tation -->
                    <div id="interpretationBox" class="rounded-xl p-6 mb-6">
                        <h3 class="font-bold text-lg mb-3 flex items-center">
                            <i class="fas fa-lightbulb mr-2"></i>
                            Interpr√©tation
                        </h3>
                        <p id="interpretationText" class="text-sm"></p>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-4 justify-center">
                        <button onclick="location.reload()"
                                class="bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition">
                            <i class="fas fa-redo mr-2"></i>Tester un autre produit
                        </button>
                        <a href="/admin/optimize-images"
                           class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-600 hover:to-teal-700 transition">
                            <i class="fas fa-rocket mr-2"></i>Lancer l'optimisation compl√®te
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
const productSelect = document.getElementById('productSelect');
const selectedProductInfo = document.getElementById('selectedProductInfo');
const selectedProductName = document.getElementById('selectedProductName');
const testBtn = document.getElementById('testBtn');
const loadingSection = document.getElementById('loadingSection');
const resultSection = document.getElementById('resultSection');

// Quand un produit est s√©lectionn√©
productSelect.addEventListener('change', function() {
    if (this.value) {
        const selectedOption = this.options[this.selectedIndex];
        selectedProductName.textContent = selectedOption.text;
        selectedProductInfo.classList.remove('hidden');
        testBtn.disabled = false;
    } else {
        selectedProductInfo.classList.add('hidden');
        testBtn.disabled = true;
    }
});

async function testOptimizeProduct() {
    const productId = productSelect.value;

    if (!productId) {
        alert('Veuillez s√©lectionner un produit');
        return;
    }

    // Afficher le chargement
    selectedProductInfo.classList.add('hidden');
    testBtn.classList.add('hidden');
    loadingSection.classList.remove('hidden');
    resultSection.classList.add('hidden');

    try {
        const response = await fetch('/admin/optimize-images/test-product', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'productId=' + productId
        });

        const data = await response.json();

        loadingSection.classList.add('hidden');

        if (data.success) {
            showProductResults(data.result);
        } else {
            alert('Erreur: ' + data.message);
            testBtn.classList.remove('hidden');
            selectedProductInfo.classList.remove('hidden');
        }
    } catch (error) {
        loadingSection.classList.add('hidden');
        alert('Erreur lors de l\'optimisation: ' + error.message);
        testBtn.classList.remove('hidden');
        selectedProductInfo.classList.remove('hidden');
    }
}

function showProductResults(result) {
    // Afficher les r√©sultats
    document.getElementById('productNameResult').textContent = 'Produit : ' + result.productName;
    document.getElementById('totalImages').textContent = result.imagesProcessed;
    document.getElementById('totalSaved').textContent = result.totalSavedKB + ' KB';
    document.getElementById('reductionPercent').textContent = result.reductionPercent.toFixed(1) + '%';

    // D√©tails par image
    const imageDetails = document.getElementById('imageDetails');
    imageDetails.innerHTML = '';

    result.details.forEach(detail => {
        const wasOptimized = detail.wasReplaced;
        const bgColor = wasOptimized ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200';
        const icon = wasOptimized ? 'fa-check-circle text-green-600' : 'fa-minus-circle text-gray-400';

        imageDetails.innerHTML += `
            <div class="${bgColor} border-2 rounded-xl p-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas ${icon} text-2xl mr-4"></i>
                        <div>
                            <p class="font-bold text-gray-800">${detail.name}</p>
                            <p class="text-sm text-gray-600">${detail.path}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">
                            ${detail.originalSizeKB} KB ‚Üí ${detail.optimizedSizeKB} KB
                        </p>
                        <p class="font-bold ${wasOptimized ? 'text-green-600' : 'text-gray-500'}">
                            ${wasOptimized ? '‚úì Optimis√©e' : '‚óã Non remplac√©e'} (${detail.savedKB} KB)
                        </p>
                    </div>
                </div>
            </div>
        `;
    });

    // Interpr√©tation
    const interpretationBox = document.getElementById('interpretationBox');
    const interpretationText = document.getElementById('interpretationText');

    if (result.reductionPercent > 50) {
        interpretationBox.className = 'bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-6';
        interpretationText.className = 'text-sm text-green-800';
        interpretationText.textContent = 'üéâ Excellente r√©duction ! Les images de ce produit √©taient tr√®s lourdes. L\'optimisation compl√®te de tous vos produits pourrait lib√©rer beaucoup d\'espace et am√©liorer significativement les performances de votre site. Gain estim√© pour tous les produits : ' + (result.totalSavedKB * 100) + ' KB environ.';
    } else if (result.reductionPercent > 20) {
        interpretationBox.className = 'bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-6';
        interpretationText.className = 'text-sm text-blue-800';
        interpretationText.textContent = 'üëç Bonne r√©duction ! Les images ont √©t√© compress√©es efficacement. Vous pouvez proc√©der √† l\'optimisation compl√®te pour am√©liorer les performances globales du site.';
    } else if (result.reductionPercent > 0) {
        interpretationBox.className = 'bg-yellow-50 border-2 border-yellow-200 rounded-xl p-6 mb-6';
        interpretationText.className = 'text-sm text-yellow-800';
        interpretationText.textContent = '‚ö†Ô∏è R√©duction mod√©r√©e. Les images de ce produit √©taient d√©j√† relativement optimis√©es. Testez sur un autre produit ou lancez l\'optimisation compl√®te pour voir l\'impact global.';
    } else {
        interpretationBox.className = 'bg-gray-50 border-2 border-gray-200 rounded-xl p-6 mb-6';
        interpretationText.className = 'text-sm text-gray-800';
        interpretationText.textContent = '‚ÑπÔ∏è Les images de ce produit √©taient d√©j√† tr√®s bien optimis√©es. Aucune r√©duction significative n\'√©tait possible sans perte de qualit√© visible.';
    }

    resultSection.classList.remove('hidden');
}
</script>

</body>
</html>
